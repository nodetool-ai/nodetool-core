services:
  api:
    image: ghcr.io/nodetool-ai/nodetool:latest
    restart: unless-stopped
    volumes:
      - ${HF_HOME:-./.cache/huggingface}:/app/huggingface
      - /var/run/docker.sock:/var/run/docker.sock
      - ${CHROMA_PATH:-./.cache/chroma}:/chroma-data
    command:
      - python
      - "-m"
      - nodetool.deploy.worker
    ports:
      - "8000:8000"
    environment:
      ENV: ${ENV:-development}
      JOB_EXECUTION_STRATEGY: ${JOB_EXECUTION_STRATEGY:-threaded}
      ASSET_BUCKET: ${ASSET_BUCKET}
      ASSET_DOMAIN: ${ASSET_DOMAIN}
      ASSET_TEMP_BUCKET: ${ASSET_TEMP_BUCKET}
      ASSET_TEMP_DOMAIN: ${ASSET_TEMP_DOMAIN}
      BRIGHTDATA_API_KEY: ${BRIGHTDATA_API_KEY}
      BRIGHTDATA_SERP_ZONE: ${BRIGHTDATA_SERP_ZONE}
      S3_ENDPOINT_URL: ${S3_ENDPOINT_URL}
      S3_ACCESS_KEY_ID: ${S3_ACCESS_KEY_ID}
      S3_SECRET_ACCESS_KEY: ${S3_SECRET_ACCESS_KEY}
      S3_REGION: ${S3_REGION}
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_KEY: ${SUPABASE_KEY}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      VLLM_BASE_URL: ${VLLM_BASE_URL}
      VLLM_API_KEY: ${VLLM_API_KEY:-}
      VLLM_HTTP_TIMEOUT: ${VLLM_HTTP_TIMEOUT:-600}
      VLLM_VERIFY_TLS: ${VLLM_VERIFY_TLS:-0}
      VLLM_CONTEXT_WINDOW: ${VLLM_CONTEXT_WINDOW:-128000}
      HF_HOME: /app/huggingface
      SENTRY_DSN: ${SENTRY_DSN}
      SECRETS_MASTER_KEY: ${SECRETS_MASTER_KEY}
      MEMCACHE_HOST: ${MEMCACHE_HOST:-memcached}
      MEMCACHE_PORT: ${MEMCACHE_PORT:-11211}
      CHROMA_PATH: /chroma-data
      PORT: ${PORT:-8000}
      CHAT_PROVIDER: ${CHAT_PROVIDER:-ollama}
      DEFAULT_MODEL: ${DEFAULT_MODEL:-gpt-oss:20b}
      WORKER_AUTH_TOKEN: ${WORKER_AUTH_TOKEN}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 6
      start_period: 30s

  memcached:
    image: memcached:bookworm
    restart: unless-stopped

  nginx:
    image: nginx:1.27-alpine
    restart: unless-stopped
    depends_on:
      api:
        condition: service_healthy
    volumes:
      - ./docker/nginx/conf.d:/etc/nginx/conf.d:ro
      - ./cert.pem:/etc/nginx/certs/cert.pem:ro
      - ./key.pem:/etc/nginx/certs/key.pem:ro
    ports:
      - 80:80
      - 443:443

networks:
  default:
    driver: bridge
