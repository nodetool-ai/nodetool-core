# GitHub Actions workflow for Docker integration testing
#
# This workflow builds the NodeTool Docker image and runs comprehensive
# integration tests against it, including:
# - Container lifecycle tests (start, stop, health checks)
# - API endpoint tests (health, workflows, jobs, settings)
# - Workflow creation and execution tests
# - Multi-step scientific workflow tests

name: Docker Integration Tests

on:
  push:
    branches: [main, develop, "copilot/*"]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:  # Allow manual trigger
    inputs:
      skip_build:
        description: "Skip Docker image build (use existing image)"
        required: false
        default: "false"
        type: boolean

env:
  DOCKER_IMAGE: nodetool:local
  TEST_CONTAINER_NAME: nodetool-test-api-integration
  TEST_PORT: 8777

jobs:
  build-image:
    name: Build Docker Image
    runs-on: ubuntu-latest
    # Skip build if requested and image exists
    if: github.event.inputs.skip_build != 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          docker build \
            --tag ${{ env.DOCKER_IMAGE }} \
            --build-arg USE_LOCAL_REPO=1 \
            --file Dockerfile \
            .

      - name: Verify image was built
        run: |
          docker images | grep nodetool

      - name: Save image to tarball
        run: |
          docker save ${{ env.DOCKER_IMAGE }} > nodetool-image.tar

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: nodetool-image.tar
          retention-days: 1

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: build-image
    if: always() && (needs.build-image.result == 'success' || github.event.inputs.skip_build == 'true')

    services:
      # Optional: PostgreSQL for database tests
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: nodetool
          POSTGRES_PASSWORD: nodetool_test
          POSTGRES_DB: nodetool_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Docker image
        if: github.event.inputs.skip_build != 'true'
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load Docker image
        if: github.event.inputs.skip_build != 'true'
        run: |
          docker load < nodetool-image.tar
          docker images | grep nodetool

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Install dependencies
        run: |
          uv sync --all-extras --dev

      - name: Create test workspace
        run: |
          mkdir -p /tmp/nodetool_test/workspace
          mkdir -p /tmp/nodetool_test/hf-cache

      - name: Start NodeTool container
        run: |
          docker run -d \
            --name ${{ env.TEST_CONTAINER_NAME }} \
            --restart unless-stopped \
            -p ${{ env.TEST_PORT }}:7777 \
            -v /tmp/nodetool_test/workspace:/workspace \
            -v /tmp/nodetool_test/hf-cache:/hf-cache \
            -e PORT=7777 \
            -e NODETOOL_API_URL=http://localhost:7777 \
            -e DB_PATH=/workspace/nodetool.db \
            -e HF_HOME=/hf-cache \
            -e ENV=test \
            -e LOG_LEVEL=INFO \
            --health-cmd "curl -f http://localhost:7777/health || exit 1" \
            --health-interval 10s \
            --health-timeout 5s \
            --health-retries 5 \
            --health-start-period 30s \
            ${{ env.DOCKER_IMAGE }}

      - name: Wait for container to be healthy
        run: |
          echo "Waiting for container to be healthy..."
          timeout 90s bash -c '
            until docker ps | grep ${{ env.TEST_CONTAINER_NAME }} | grep -q "healthy"; do
              echo "Container not healthy yet, waiting..."
              sleep 5
              docker ps -a
              docker logs --tail 20 ${{ env.TEST_CONTAINER_NAME }}
            done
            echo "Container is healthy!"
          '
          docker ps

      - name: Wait for API to be ready
        run: |
          echo "Waiting for API to be ready..."
          timeout 60s bash -c '
            until curl -s http://localhost:${{ env.TEST_PORT }}/health | grep -q "OK"; do
              echo "API not ready yet, waiting..."
              sleep 2
            done
            echo "API is ready!"
          '

      - name: Show container logs (for debugging)
        run: |
          echo "=== Container logs ==="
          docker logs --tail 50 ${{ env.TEST_CONTAINER_NAME }}
        if: always()

      - name: Test health endpoint
        run: |
          response=$(curl -s http://localhost:${{ env.TEST_PORT }}/health)
          echo "Health check response: $response"
          [ "$response" == '"OK"' ]

      - name: Test workflows endpoint
        run: |
          response=$(curl -s http://localhost:${{ env.TEST_PORT }}/api/workflows/)
          echo "Workflows response: $response"
          echo "$response" | grep -q '"workflows"'

      - name: Test settings endpoint
        run: |
          response=$(curl -s http://localhost:${{ env.TEST_PORT }}/api/settings/)
          echo "Settings response (first 500 chars): ${response:0:500}"
          echo "$response" | grep -q '"settings"'

      - name: Test jobs endpoint
        run: |
          response=$(curl -s http://localhost:${{ env.TEST_PORT }}/api/jobs/)
          echo "Jobs response: $response"
          echo "$response" | grep -q '"jobs"'

      - name: Run Python integration tests
        run: |
          uv run pytest \
            tests/deploy/test_docker_api_integration.py \
            -v \
            -m integration \
            --timeout=300 \
            -k "test_health_endpoint or test_workflows_api_endpoint or test_settings_api_endpoint or test_jobs_api_endpoint or test_create_workflow or test_run_workflow"

      - name: Run comprehensive workflow tests
        run: |
          uv run pytest \
            tests/deploy/test_docker_api_integration.py \
            -v \
            -m integration \
            --timeout=300 \
            -k "test_workflow_execution_result or test_scientific_workflow_execution or test_delete_workflow"

      - name: Show container logs on failure
        run: |
          echo "=== Full container logs ==="
          docker logs ${{ env.TEST_CONTAINER_NAME }}
        if: failure()

      - name: Cleanup container
        run: |
          docker stop ${{ env.TEST_CONTAINER_NAME }} || true
          docker rm ${{ env.TEST_CONTAINER_NAME }} || true
        if: always()

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [build-image, integration-tests]
    if: always()

    steps:
      - name: Check build status
        run: |
          if [ "${{ needs.build-image.result }}" != "success" ] && [ "${{ github.event.inputs.skip_build }}" != "true" ]; then
            echo "❌ Docker image build failed"
            exit 1
          fi
          echo "✅ Docker image build succeeded (or was skipped)"

      - name: Check integration test status
        run: |
          if [ "${{ needs.integration-tests.result }}" != "success" ]; then
            echo "❌ Integration tests failed"
            exit 1
          fi
          echo "✅ All integration tests passed"

      - name: Summary
        run: |
          echo "## Docker Integration Test Results :docker:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Status**: ${{ needs.build-image.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Test Status**: ${{ needs.integration-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.integration-tests.result }}" == "success" ]; then
            echo "### ✅ All tests passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ❌ Some tests failed" >> $GITHUB_STEP_SUMMARY
          fi
